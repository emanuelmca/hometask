<app-nav></app-nav>

<div class="tasks-container">
  <div class="container">
    
    <!-- HEADER -->
    <div class="tasks-header">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h1>ğŸ“‹ GestiÃ³n de Tareas</h1>
          <p class="text-muted">Organiza y gestiona las tareas de tu hogar</p>
        </div>
        <div class="col-md-4 text-end">
          <button class="btn btn-primary" (click)="abrirModalCrearTarea()">
            â• Nueva Tarea
          </button>
        </div>
      </div>
    </div>

    <!-- FILTROS Y ESTADÃSTICAS -->
    <div class="tasks-filters">
      <div class="row">
        <div class="col-md-8">
          <div class="filter-buttons">
            <button 
              class="btn-filter" 
              [class.active]="filtroEstado === 'todas'"
              (click)="filtrarTareas('todas')"
            >
              Todas ({{ tareas.length }})
            </button>
            <button 
              class="btn-filter" 
              [class.active]="filtroEstado === 'pendiente'"
              (click)="filtrarTareas('pendiente')"
            >
              Pendientes ({{ contarTareasPorEstado('pendiente') }})
            </button>
            <button 
              class="btn-filter" 
              [class.active]="filtroEstado === 'en_progreso'"
              (click)="filtrarTareas('en_progreso')"
            >
              En Progreso ({{ contarTareasPorEstado('en_progreso') }})
            </button>
            <button 
              class="btn-filter" 
              [class.active]="filtroEstado === 'completada'"
              (click)="filtrarTareas('completada')"
            >
              Completadas ({{ contarTareasPorEstado('completada') }})
            </button>
          </div>
        </div>
        <div class="col-md-4 text-end">
          <div class="tasks-stats">
            <span class="stat-item">
              ğŸ“Š Total: {{ tareas.length }}
            </span>
            <span class="stat-item">
              âœ… {{ contarTareasPorEstado('completada') }} completadas
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- MENSAJES DE ESTADO -->
    <div *ngIf="errorMessage" class="alert alert-danger">
      {{ errorMessage }}
      <button type="button" class="btn-close" (click)="errorMessage = ''"></button>
    </div>

    <!-- LOADING -->
    <div *ngIf="loading" class="loading-container">
      <div class="spinner-border text-primary"></div>
      <p>Cargando tareas...</p>
    </div>

    <!-- LISTA DE TAREAS -->
    <div class="tasks-list" *ngIf="!loading && tareasFiltradas.length > 0">
      <div class="task-card" *ngFor="let tarea of tareasFiltradas" [class]="'estado-' + tarea.estado_actual">
        
        <!-- HEADER DE LA TAREA -->
        <div class="task-header">
          <div class="task-title-section">
            <h3 class="task-title">{{ tarea.titulo }}</h3>
            <span class="task-badge" [class]="'badge-' + tarea.estado_actual">
              {{ getEstadoTexto(tarea.estado_actual) }}
            </span>
          </div>
          <div class="task-actions">
            <button class="btn-action" (click)="editarTarea(tarea)" title="Editar">
              âœï¸
            </button>
            <button class="btn-action" (click)="cambiarEstadoTarea(tarea)" title="Cambiar estado">
              ğŸ”„
            </button>
          </div>
        </div>

        <!-- DESCRIPCIÃ“N -->
        <p class="task-description" *ngIf="tarea.descripcion">{{ tarea.descripcion }}</p>

        <!-- DETALLES -->
        <div class="task-details">
          <div class="task-detail">
            <span class="detail-label">ğŸ“ CategorÃ­a:</span>
            <span class="detail-value">{{ tarea.categoria || 'Sin categorÃ­a' }}</span>
          </div>
          
          <div class="task-detail">
            <span class="detail-label">ğŸ‘¤ Asignado a:</span>
            <span class="detail-value">
              {{ obtenerNombreMiembro(tarea.asignado_a) || 'No asignado' }}
            </span>
          </div>
          
          <div class="task-detail" *ngIf="tarea.fecha_limite">
            <span class="detail-label">ğŸ“… Fecha lÃ­mite:</span>
            <span class="detail-value">{{ tarea.fecha_limite | date:'mediumDate' }}</span>
          </div>
          
          <div class="task-detail">
            <span class="detail-label">ğŸ• Creado:</span>
            <span class="detail-value">{{ tarea.fecha_creacion | date:'medium' }}</span>
          </div>
        </div>

        <!-- PROGRESO (si estÃ¡ en progreso) -->
        <div class="task-progress" *ngIf="tarea.estado_actual === 'en_progreso' && tarea.tiempo_total_segundos">
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="calcularProgreso(tarea)"></div>
          </div>
          <span class="progress-text">{{ calcularProgreso(tarea) }}% completado</span>
        </div>

      </div>
    </div>

    <!-- ESTADO VACÃO -->
    <div *ngIf="!loading && tareasFiltradas.length === 0" class="empty-state">
      <div class="empty-icon">ğŸ“‹</div>
      <h3>No hay tareas</h3>
      <p *ngIf="filtroEstado !== 'todas'">
        No hay tareas con estado "{{ getEstadoTexto(filtroEstado) }}"
      </p>
      <p *ngIf="filtroEstado === 'todas'">
        Comienza creando la primera tarea para tu hogar
      </p>
      <button class="btn btn-primary" (click)="abrirModalCrearTarea()">
        â• Crear Primera Tarea
      </button>
    </div>

  </div>
</div>

<!-- MODAL PARA CREAR/EDITAR TAREA -->
<div class="modal-overlay" *ngIf="mostrarModal" (click)="cerrarModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    
    <div class="modal-header">
      <h3>{{ editando ? 'âœï¸ Editar Tarea' : 'â• Crear Nueva Tarea' }}</h3>
      <button class="close-btn" (click)="cerrarModal()">Ã—</button>
    </div>

    <div class="modal-body">
      
      <div *ngIf="errorModal" class="alert alert-danger">
        {{ errorModal }}
      </div>

      <form (ngSubmit)="guardarTarea()" #tareaForm="ngForm">
        
        <div class="form-group">
          <label>TÃ­tulo *</label>
          <input 
            type="text" 
            class="form-control"
            [(ngModel)]="nuevaTarea.titulo"
            name="titulo"
            required
            placeholder="Ej: Lavar los platos"
          >
        </div>

        <div class="form-group">
          <label>DescripciÃ³n</label>
          <textarea 
            class="form-control"
            [(ngModel)]="nuevaTarea.descripcion"
            name="descripcion"
            rows="3"
            placeholder="DescripciÃ³n detallada de la tarea..."
          ></textarea>
        </div>

        <div class="form-group">
          <label>CategorÃ­a</label>
          <input 
            type="text" 
            class="form-control"
            [(ngModel)]="nuevaTarea.categoria"
            name="categoria"
            placeholder="Ej: Limpieza, Cocina, Mantenimiento..."
          >
        </div>

        <div class="form-group">
          <label>Asignar a *</label>
          <select 
            class="form-control"
            [(ngModel)]="nuevaTarea.asignado_a"
            name="asignado_a"
            required
          >
            <option value="">Seleccionar miembro</option>
            <option *ngFor="let miembro of miembros" [value]="miembro.id">
              {{ miembro.nombre_completo }} ({{ miembro.rol.nombre }})
            </option>
          </select>
        </div>

        <div class="form-group">
          <label>Fecha LÃ­mite</label>
          <input 
            type="date" 
            class="form-control"
            [(ngModel)]="nuevaTarea.fecha_limite"
            name="fecha_limite"
          >
        </div>

        <div class="form-actions">
          <button 
            type="button" 
            class="btn btn-secondary"
            (click)="cerrarModal()"
          >
            Cancelar
          </button>
          <button 
            type="submit" 
            class="btn btn-primary"
            [disabled]="!tareaForm.form.valid || guardandoTarea"
          >
            <span *ngIf="guardandoTarea" class="spinner"></span>
            {{ guardandoTarea ? 'Guardando...' : (editando ? 'Actualizar' : 'Crear Tarea') }}
          </button>
        </div>

      </form>

    </div>

  </div>
</div>

<!-- CHAT FLOTANTE -->
<app-chat-floating></app-chat-floating>
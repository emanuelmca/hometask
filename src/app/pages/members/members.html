<app-nav></app-nav>

<div class="members-container">
  <div class="container">

    <!-- HEADER MEJORADO -->
    <div class="members-header text-center">
      <div class="row align-items-center">
        <div class="col-md-8 text-md-start">
          <h2>GestiÃ³n de Miembros</h2>
          <p class="text-muted mb-0">Administra los miembros de tu hogar</p>
        </div>
        <div class="col-md-4 text-md-end">
          <div class="d-flex align-items-center justify-content-md-end justify-content-center gap-3">
            <span class="members-count">
              ğŸ“Š Total: {{ miembros.length }} miembro{{ miembros.length !== 1 ? 's' : '' }}
            </span>
            <button class="btn btn-add-member" (click)="abrirModalAgregar()">
              â• Nuevo Miembro
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- MENSAJES DE ESTADO -->
    <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
      <strong>âš ï¸ Error:</strong> {{ errorMessage }}
      <button type="button" class="btn-close" (click)="errorMessage = ''"></button>
    </div>

    <!-- LOADING -->
    <div *ngIf="loading" class="loading-container">
      <div class="spinner-border spinner-large text-primary" role="status">
        <span class="visually-hidden">Cargando miembros...</span>
      </div>
      <p class="mt-3 text-muted">Cargando miembros...</p>
    </div>

    <!-- ESTADO VACÃO -->
    <div *ngIf="!loading && miembros.length === 0 && !errorMessage" class="empty-state">
      <div class="empty-icon mb-4">ğŸ‘¥</div>
      <h4>No hay miembros en este hogar</h4>
      <p class="text-muted">Comienza agregando el primer miembro a tu hogar familiar</p>
      <button class="btn btn-add-member" (click)="abrirModalAgregar()">
        â• Agregar Primer Miembro
      </button>
    </div>

    <!-- GRID DE MIEMBROS -->
    <div class="members-grid" *ngIf="!loading && miembros.length > 0">
      <div class="member-card" *ngFor="let m of miembros">
        <div class="card-body">

          <!-- HEADER CON NOMBRE Y ESTADO -->
          <div class="member-header">
            <h5 class="member-name">{{ m.nombre_completo }}</h5>
            <span class="status-badge" [ngClass]="m.estado ? 'badge-active' : 'badge-inactive'">
              {{ m.estado ? 'Activo' : 'Inactivo' }}
            </span>
          </div>

          <!-- INFORMACIÃ“N DEL MIEMBRO -->
          <div class="member-info">
            <div class="info-item">
              <span>ğŸ“§</span>
              <span class="ms-2">{{ m.correo_electronico }}</span>
            </div>

            <div class="info-item">
              <span>ğŸ·ï¸</span>
              <span class="ms-2">
                Rol: <span class="role-badge">{{ m.rol?.nombre || 'Sin rol' }}</span>
              </span>
            </div>

            <div class="info-item">
              <span>ğŸ </span>
              <span class="ms-2">Hogar #{{ m.id_hogar }}</span>
            </div>

            <div class="info-item">
              <span>ğŸ“…</span>
              <span class="ms-2">Creado: {{ m.fecha_creacion | date:'mediumDate' }}</span>
            </div>
          </div>

          <!-- ACCIONES -->
          <div class="member-actions">
            <button class="btn-action btn-edit" (click)="editarMiembro(m)">
              âœï¸ Editar
            </button>
            <button class="btn-action btn-deactivate" (click)="cambiarEstado(m)" [class.btn-activate]="!m.estado">
              {{ m.estado ? 'ğŸš« Desactivar' : 'âœ… Activar' }}
            </button>
          </div>

        </div>
      </div>
    </div>

  </div>
</div>

<!-- MODAL PARA AGREGAR/EDITAR MIEMBRO -->
<div class="modal fade" [class.show]="mostrarModal" [style.display]="mostrarModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          {{ editando ? 'âœï¸ Editar Miembro' : 'â• Agregar Nuevo Miembro' }}
        </h5>
        <button type="button" class="btn-close" (click)="cerrarModal()">Ã—</button>
      </div>

      <div class="modal-body">
        <div *ngIf="errorAgregar" class="alert alert-danger">
          {{ errorAgregar }}
        </div>

        <form (ngSubmit)="agregarMiembro()" #miembroForm="ngForm">
          <div class="mb-3">
            <label class="form-label">Nombre Completo *</label>
            <input type="text" class="form-control" [(ngModel)]="nuevoMiembro.nombre_completo" name="nombre_completo"
              required placeholder="Ej: Juan PÃ©rez">
          </div>

          <div class="mb-3">
            <label class="form-label">Correo ElectrÃ³nico *</label>
            <input type="email" class="form-control" [(ngModel)]="nuevoMiembro.correo_electronico"
              name="correo_electronico" required placeholder="Ej: usuario@ejemplo.com">


            <!-- En el formulario del modal -->
            <div class="mb-3" *ngIf="!editando">
              <label class="form-label">ContraseÃ±a *</label>
              <input type="password" class="form-control" [(ngModel)]="nuevoMiembro.contrasena" name="contrasena"
                [required]="!editando" placeholder="MÃ­nimo 6 caracteres">
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Rol *</label>
            <select class="form-select" [(ngModel)]="nuevoMiembro.id_rol" name="id_rol" required>
              <option value="">Seleccionar rol</option>
              <option value="1">Administrador</option>
              <option value="2">Miembro</option>
              <!-- Agrega mÃ¡s roles segÃºn tu API -->
            </select>
          </div>


          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="cerrarModal()">
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="!miembroForm.form.valid || agregandoMiembro">
              <span *ngIf="agregandoMiembro" class="spinner-border spinner-border-sm me-2"></span>
              {{ agregandoMiembro ? 'Procesando...' : (editando ? 'Actualizar' : 'Agregar Miembro') }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- FONDO DEL MODAL -->
<div *ngIf="mostrarModal" class="modal-backdrop fade show"></div>

<!-- CHAT FLOTANTE -->
<app-chat-floating></app-chat-floating>
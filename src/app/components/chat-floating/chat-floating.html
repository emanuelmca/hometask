<!-- BotÃ³n flotante -->
<button class="chat-float-btn" (click)="toggleChat()" [attr.aria-label]="isOpen ? 'Cerrar chat' : 'Abrir chat'">
  <span style="margin-top: -2px;">ðŸ’¬</span>
  <span class="notification-badge" *ngIf="unreadMessages > 0">{{ unreadMessages }}</span>
</button>

<!-- Ventana de chat -->
<div class="chat-box" *ngIf="isOpen">

  <!-- Header del chat -->
  <div class="chat-header">
    <div class="chat-header-info">
      <span class="chat-title" *ngIf="!contactoSeleccionado">Chat Familiar</span>
      <span class="chat-title" *ngIf="contactoSeleccionado">
        {{ obtenerNombreContacto() }}
      </span>
      <span class="chat-subtitle" *ngIf="!contactoSeleccionado">
        {{ miembros.length }} miembros
      </span>
      <span class="chat-subtitle" *ngIf="contactoSeleccionado">
        {{ obtenerRolContacto() }}
      </span>
    </div>
    <div class="chat-header-actions">
      <button class="header-btn" *ngIf="contactoSeleccionado" (click)="volverALista()" title="Volver a contactos">
        â€¹
      </button>
      <button class="close-btn" (click)="toggleChat()" title="Cerrar chat">âœ–</button>
    </div>
  </div>

  <!-- Lista de contactos -->
  <div class="contacts-list" *ngIf="!contactoSeleccionado">
    <div class="contacts-search">
      <input type="text" placeholder="Buscar contacto..." [(ngModel)]="busquedaContacto" class="search-input">
    </div>

    <div class="contacts-container">
      <div class="contact-item" *ngFor="let miembro of contactosFiltrados; trackBy: trackByMiembro"
        (click)="seleccionarContacto(miembro.id)">
        <div class="contact-avatar">
          {{ obtenerIniciales(miembro.nombre_completo) }}
        </div>
        <div class="contact-info">
          <div class="contact-name">{{ miembro.nombre_completo }}</div>
          <div class="contact-role">{{ miembro.rol.nombre }}</div>
          <div class="contact-last-msg" *ngIf="obtenerUltimoMensaje(miembro.id) as ultimoMsg">
            {{ ultimoMsg.contenido }}
          </div>
        </div>
        <div class="contact-meta">
          <div class="contact-time" *ngIf="obtenerUltimoMensaje(miembro.id) as ultimoMsg">
            {{ ultimoMsg.fecha_envio | date:'HH:mm' }}
          </div>
          <div class="contact-badge" *ngIf="obtenerMensajesNoLeidos(miembro.id) > 0">
            {{ obtenerMensajesNoLeidos(miembro.id) }}
          </div>
        </div>
      </div>

      <!-- Sin contactos -->
      <div class="no-contacts" *ngIf="contactosFiltrados.length === 0">
        <div class="no-contacts-icon">ðŸ‘¥</div>
        <p>No se encontraron contactos</p>
      </div>
    </div>
  </div>

  <!-- Cuerpo del chat -->
  <div class="chat-body" #chatBody *ngIf="contactoSeleccionado">

    <!-- Loading -->
    <div class="loading-messages" *ngIf="cargandoMensajes">
      <div class="spinner-small"></div>
      <span>Cargando conversaciÃ³n...</span>
    </div>

    <!-- Mensajes -->
    <div *ngIf="!cargandoMensajes">
      <div class="message-date" *ngFor="let grupo of mensajesAgrupados; trackBy: trackByGrupo">
        <span class="date-separator">{{ grupo.fecha }}</span>
        <div class="msg" [class.me]="mensaje.id_remitente === miId" [class.other]="mensaje.id_remitente !== miId"
          *ngFor="let mensaje of grupo.mensajes; trackBy: trackByMensaje">
          <div class="msg-content">{{ mensaje.contenido }}</div>
          <div class="msg-time">
            {{ mensaje.fecha_envio | date:'HH:mm' }}
            <span class="msg-status" *ngIf="mensaje.id_remitente === miId">âœ“</span>
          </div>
        </div>
      </div>

      <!-- Sin mensajes -->
      <div class="no-messages" *ngIf="mensajes.length === 0">
        <div class="no-messages-icon">ðŸ’¬</div>
        <h4>No hay mensajes</h4>
        <p>EnvÃ­a un mensaje a {{ obtenerNombreContacto() }} para comenzar la conversaciÃ³n.</p>
      </div>
    </div>

  </div>

  <!-- Input de mensaje -->
  <div class="chat-input" *ngIf="contactoSeleccionado">
    <input type="text" placeholder="Escribe un mensaje..." [(ngModel)]="nuevoMensaje" (keyup.enter)="enviarMensaje()"
      [disabled]="enviandoMensaje">
    <button (click)="enviarMensaje()" [disabled]="!nuevoMensaje.trim() || enviandoMensaje" class="send-btn"
      [title]="enviandoMensaje ? 'Enviando...' : 'Enviar mensaje'">
      <span *ngIf="enviandoMensaje" class="spinner-small"
        style="border-color: rgba(255,255,255,0.3); border-top-color: white;"></span>
      <span *ngIf="!enviandoMensaje">âž¤</span>
    </button>
  </div>
</div>